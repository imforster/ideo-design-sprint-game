<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IDEO Design Sprint Game</title>
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.production.min.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
    ></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <style>
      body {
        margin: 0;
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen",
          "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans", "Helvetica Neue",
          sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      /* Ensure modals are scrollable on mobile */
      @media (max-width: 768px) {
        .modal-content {
          max-height: 85vh;
          overflow-y: auto;
        }
      }

      /* Improve touch targets for mobile */
      @media (max-width: 768px) {
        button,
        input[type="checkbox"],
        select {
          min-height: 44px;
          min-width: 44px;
        }
      }

      /* Smooth transitions for all interactive elements */
      button,
      input,
      textarea,
      select {
        transition: all 0.2s ease-in-out;
      }

      /* Focus visible for accessibility */
      *:focus-visible {
        outline: 2px solid #3b82f6;
        outline-offset: 2px;
      }

      /* Improve checkbox visibility */
      input[type="checkbox"] {
        cursor: pointer;
        width: 18px;
        height: 18px;
      }

      /* Image thumbnail hover effect */
      .image-thumbnail {
        transition:
          transform 0.2s ease-in-out,
          box-shadow 0.2s ease-in-out;
      }

      .image-thumbnail:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect } = React;

      // Supabase configuration from external config
      const supabase = window.SUPABASE_CONFIG && window.supabase?.createClient(
        window.SUPABASE_CONFIG.url,
        window.SUPABASE_CONFIG.anonKey,
      );

      // Lucide React icons as inline SVGs
      const Icons = {
        Sparkles: (props) => (
          <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"
            />
          </svg>
        ),
        Users: (props) => (
          <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"
            />
          </svg>
        ),
        Lightbulb: (props) => (
          <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"
            />
          </svg>
        ),
        Target: (props) => (
          <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8zm0-14a6 6 0 1 0 6 6 6 6 0 0 0-6-6zm0 10a4 4 0 1 1 4-4 4 4 0 0 1-4 4z"
            />
          </svg>
        ),
        Rocket: (props) => (
          <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M13 10V3L4 14h7v7l9-11h-7z"
            />
          </svg>
        ),
        RefreshCw: (props) => (
          <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
            />
          </svg>
        ),
        Trophy: (props) => (
          <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"
            />
          </svg>
        ),
        Clock: (props) => (
          <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
            />
          </svg>
        ),
        Plus: (props) => (
          <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M12 4v16m8-8H4"
            />
          </svg>
        ),
        X: (props) => (
          <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M6 18L18 6M6 6l12 12"
            />
          </svg>
        ),
        Download: (props) => (
          <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
            />
          </svg>
        ),
        Copy: (props) => (
          <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
            />
          </svg>
        ),
        Share2: (props) => (
          <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"
            />
          </svg>
        ),
        Settings: (props) => (
          <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
            />
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
            />
          </svg>
        ),
        Upload: (props) => (
          <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"
            />
          </svg>
        ),
        Image: (props) => (
          <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
            />
          </svg>
        ),
        Mail: (props) => (
          <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
            />
          </svg>
        ),
      };

      const IDEOGame = () => {
        const [gameState, setGameState] = useState("intro");
        const [gameMode, setGameMode] = useState(null);
        const [currentPhase, setCurrentPhase] = useState(0);
        const [challenge, setChallenge] = useState(null);
        const [userInput, setUserInput] = useState("");
        const [ideas, setIdeas] = useState([]);
        const [selectedIdeas, setSelectedIdeas] = useState([]);
        const [prototype, setPrototype] = useState(null);
        const [prototypeImages, setPrototypeImages] = useState([]);
        const [score, setScore] = useState(0);
        const [timer, setTimer] = useState(180);
        const [timerActive, setTimerActive] = useState(false);
        const [timerDuration, setTimerDuration] = useState(180);
        const [customTimerInput, setCustomTimerInput] = useState("");
        const [timerError, setTimerError] = useState("");
        const [showSettings, setShowSettings] = useState(false);
        const [showShare, setShowShare] = useState(false);
        const [showEmailModal, setShowEmailModal] = useState(false);
        const [emailForm, setEmailForm] = useState({
          recipients: "",
          subject: "",
          message: "",
        });

        const [teamName, setTeamName] = useState("");
        const [playerName, setPlayerName] = useState("");
        const [teamMembers, setTeamMembers] = useState([]);
        const [hmwStatement, setHmwStatement] = useState("");
        const [iterationNotes, setIterationNotes] = useState("");

        const [customChallenges, setCustomChallenges] = useState([]);
        const [showAddChallenge, setShowAddChallenge] = useState(false);
        const [newChallenge, setNewChallenge] = useState({
          title: "",
          description: "",
          persona: "",
          painPoint: "",
          topic: "",
        });
        const [enabledChallenges, setEnabledChallenges] = useState(new Set());

        // Collaborative session state
        const [sessionId, setSessionId] = useState(null);
        const [isHost, setIsHost] = useState(false);
        const [userName, setUserName] = useState("");
        const [joinCode, setJoinCode] = useState("");
        const [participants, setParticipants] = useState([]);
        const [isCollaborative, setIsCollaborative] = useState(false);

        // Import/Export state
        const [importPreviewData, setImportPreviewData] = useState([]);
        const [showImportPreview, setShowImportPreview] = useState(false);

        // Challenge JSON schema constant
        const CHALLENGE_SCHEMA_VERSION = "1.0";

        const TOPICS = [
          "Education",
          "Business",
          "Healthcare",
          "Technology",
          "Sustainability",
          "Social Impact",
          "Product Design",
          "Service Design",
          "Custom",
        ];

        const getTopicColor = (topic) => {
          const colors = {
            Education: "bg-blue-100 text-blue-900 border border-blue-300",
            Business: "bg-purple-100 text-purple-900 border border-purple-300",
            Healthcare: "bg-red-100 text-red-900 border border-red-300",
            Technology: "bg-cyan-100 text-cyan-900 border border-cyan-300",
            Sustainability:
              "bg-green-100 text-green-900 border border-green-300",
            "Social Impact":
              "bg-orange-100 text-orange-900 border border-orange-300",
            "Product Design":
              "bg-pink-100 text-pink-900 border border-pink-300",
            "Service Design":
              "bg-indigo-100 text-indigo-900 border border-indigo-300",
            Custom: "bg-gray-100 text-gray-900 border border-gray-300",
          };
          return (
            colors[topic] || "bg-gray-100 text-gray-900 border border-gray-300"
          );
        };

        const defaultChallenges = [
          {
            title: "Campus Coffee Crisis",
            description:
              "Students are falling asleep in afternoon classes. The campus coffee shop has long lines and limited seating.",
            persona:
              "Sarah, a sophomore juggling 18 credits and part-time work",
            painPoint:
              "Needs caffeine but can't afford to miss class waiting in line",
            topic: "Education",
          },
          {
            title: "Remote Team Disconnect",
            description:
              "A fully remote startup is struggling with team bonding and spontaneous collaboration.",
            persona:
              "Marcus, a new developer who's never met his teammates in person",
            painPoint:
              "Feels isolated and misses the energy of working alongside others",
            topic: "Business",
          },
          {
            title: "Sustainable Shopping Struggle",
            description:
              "Consumers want to shop sustainably but find it confusing and time-consuming to verify eco-friendly claims.",
            persona: "Elena, an environmentally conscious parent of two",
            painPoint:
              "Overwhelmed by greenwashing and conflicting information",
            topic: "Sustainability",
          },
          {
            title: "Fitness Motivation Gap",
            description:
              "Gym memberships go unused after the initial enthusiasm fades in a few weeks.",
            persona: "James, a 35-year-old professional with good intentions",
            painPoint:
              "Starts strong but loses motivation when results aren't immediate",
            topic: "Healthcare",
          },
        ];

        const allChallenges = [...defaultChallenges, ...customChallenges];

        // Initialize enabledChallenges with all challenges
        useEffect(() => {
          const allTitles = allChallenges.map((c) => c.title);
          setEnabledChallenges(new Set(allTitles));
        }, [allChallenges.length]);

        const phases = [
          {
            name: "Empathize",
            icon: Icons.Users,
            color: "bg-blue-500",
            instruction:
              "Create a 'How Might We...' statement that reframes this challenge as an opportunity.",
            placeholder: "How might we help...",
            tip: "Focus on the human need, not the solution. Start with 'How might we help [persona] to [goal] so that [benefit]?'",
          },
          {
            name: "Ideate",
            icon: Icons.Lightbulb,
            color: "bg-yellow-500",
            instruction: "Generate wild ideas! No judgment, go for quantity!",
            placeholder: "Type an idea and press Enter...",
            tip: "Think: What would Apple do? What if budget was unlimited? What's the opposite of obvious?",
          },
          {
            name: "Select",
            icon: Icons.Target,
            color: "bg-green-500",
            instruction:
              "Choose your top 3 ideas based on: Desirability, Feasibility, and Innovation",
            tip: "Look for ideas that users want, you can build, and that feel fresh or unexpected.",
          },
          {
            name: "Prototype",
            icon: Icons.Rocket,
            color: "bg-purple-500",
            instruction:
              "Describe a simple prototype for your best idea. How would you test it in 48 hours?",
            placeholder: "Our prototype is...",
            tip: "Keep it rough! Sketch, storyboard, or role-play. The goal is to learn, not to perfect.",
          },
          {
            name: "Iterate",
            icon: Icons.RefreshCw,
            color: "bg-pink-500",
            instruction:
              "Reflect: What feedback would improve this? What's the smallest testable version?",
            placeholder: "I would improve this by...",
            tip: "Use: I like... I wish... What if... to refine your concept.",
          },
        ];

        const addCustomChallenge = () => {
          if (
            newChallenge.title &&
            newChallenge.description &&
            newChallenge.persona &&
            newChallenge.painPoint &&
            newChallenge.topic
          ) {
            setCustomChallenges([...customChallenges, { ...newChallenge }]);
            // Enable the new challenge by default
            const newEnabled = new Set(enabledChallenges);
            newEnabled.add(newChallenge.title);
            setEnabledChallenges(newEnabled);
            setNewChallenge({
              title: "",
              description: "",
              persona: "",
              painPoint: "",
              topic: "",
            });
            setShowAddChallenge(false);
          } else {
            alert("Please fill in all fields for the challenge");
          }
        };

        const exportChallenges = () => {
          const exportData = {
            version: CHALLENGE_SCHEMA_VERSION,
            exportDate: new Date().toISOString(),
            challenges: customChallenges,
          };

          const jsonString = JSON.stringify(exportData, null, 2);
          const blob = new Blob([jsonString], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          const timestamp = new Date().toISOString().split("T")[0];
          a.download = `ideo-challenges-${timestamp}.json`;
          a.click();
          URL.revokeObjectURL(url);
        };

        const validateChallengeJSON = (data) => {
          // Check if data is an object
          if (!data || typeof data !== "object") {
            return { valid: false, error: "Invalid JSON structure" };
          }

          // Check for version field
          if (!data.version || data.version !== CHALLENGE_SCHEMA_VERSION) {
            return {
              valid: false,
              error: `Invalid or missing version. Expected version ${CHALLENGE_SCHEMA_VERSION}`,
            };
          }

          // Check for challenges array
          if (!Array.isArray(data.challenges)) {
            return {
              valid: false,
              error: "Missing or invalid challenges array",
            };
          }

          // Check if there's at least one challenge
          if (data.challenges.length === 0) {
            return { valid: false, error: "No challenges found in the file" };
          }

          // Validate each challenge has required fields
          const requiredFields = [
            "title",
            "description",
            "persona",
            "painPoint",
            "topic",
          ];
          const missingFields = [];

          for (let i = 0; i < data.challenges.length; i++) {
            const challenge = data.challenges[i];

            for (const field of requiredFields) {
              if (
                !challenge[field] ||
                typeof challenge[field] !== "string" ||
                challenge[field].trim() === ""
              ) {
                missingFields.push(
                  `Challenge ${i + 1}: missing or invalid "${field}"`,
                );
              }
            }
          }

          if (missingFields.length > 0) {
            return {
              valid: false,
              error: `Some challenges are missing required fields:\n${missingFields.join("\n")}`,
            };
          }

          return { valid: true };
        };

        const handleImportFile = (event) => {
          const file = event.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const jsonData = JSON.parse(e.target.result);
              const validationResult = validateChallengeJSON(jsonData);

              if (validationResult.valid) {
                setImportPreviewData(jsonData.challenges);
                setShowImportPreview(true);
              } else {
                alert(`Invalid JSON file: ${validationResult.error}`);
              }
            } catch (error) {
              alert(
                "Invalid JSON file. Please check the file format and try again.",
              );
            }
          };
          reader.readAsText(file);

          // Reset the input so the same file can be selected again
          event.target.value = "";
        };

        const confirmImport = () => {
          // Filter out duplicates based on title matching (case-insensitive)
          const existingTitles = customChallenges.map((c) =>
            c.title.toLowerCase(),
          );
          const newChallenges = importPreviewData.filter(
            (challenge) =>
              !existingTitles.includes(challenge.title.toLowerCase()),
          );

          const skippedCount = importPreviewData.length - newChallenges.length;

          // Merge new challenges into customChallenges
          setCustomChallenges([...customChallenges, ...newChallenges]);

          // Enable all imported challenges by default
          const newEnabled = new Set(enabledChallenges);
          newChallenges.forEach((challenge) => {
            newEnabled.add(challenge.title);
          });
          setEnabledChallenges(newEnabled);

          // Display success message
          let message = `Successfully imported ${newChallenges.length} challenge${newChallenges.length !== 1 ? "s" : ""}`;
          if (skippedCount > 0) {
            message += `\n${skippedCount} duplicate${skippedCount !== 1 ? "s" : ""} skipped`;
          }
          alert(message);

          // Clear import preview data
          setImportPreviewData([]);
        };

        const toggleChallengeEnabled = (title) => {
          const newEnabled = new Set(enabledChallenges);
          if (newEnabled.has(title)) {
            newEnabled.delete(title);
          } else {
            newEnabled.add(title);
          }
          setEnabledChallenges(newEnabled);
        };

        const selectAllChallenges = () => {
          const allTitles = allChallenges.map((c) => c.title);
          setEnabledChallenges(new Set(allTitles));
        };

        const deselectAllChallenges = () => {
          setEnabledChallenges(new Set());
        };

        const getEnabledChallenges = () => {
          return allChallenges.filter((c) => enabledChallenges.has(c.title));
        };

        // Collaborative session functions
        const createSession = async () => {
          if (!supabase) {
            alert(
              "Supabase not configured. Please add your Supabase URL and key.",
            );
            return;
          }

          try {
            const hostId = crypto.randomUUID();
            const { data: session, error } = await supabase
              .from("sessions")
              .insert({ host_id: hostId })
              .select()
              .single();

            if (error) throw error;

            const initialData = {
              currentPhase: 0,
              timerActive: false,
              timerDuration: 180,
              challenge: null,
              allIdeas: [],
              selectedIdeas: [],
              prototype: null,
              prototypeImages: [],
              hmwStatement: "",
              iterationNotes: "",
              participants: [{ id: hostId, name: userName, isHost: true }],
              collaborativeScore: 0,
            };

            await supabase.from("session_data").insert({
              session_id: session.id,
              data: initialData,
            });

            setSessionId(session.id);
            setIsHost(true);
            setIsCollaborative(true);
            setParticipants([{ id: hostId, name: userName, isHost: true }]);
          } catch (error) {
            console.error("Error creating session:", error);
            alert("Failed to create session. Please try again.");
          }
        };

        const joinSession = async (code) => {
          if (!supabase) {
            alert(
              "Supabase not configured. Please add your Supabase URL and key.",
            );
            return;
          }

          try {
            const { data, error } = await supabase
              .from("session_data")
              .select("*")
              .eq("session_id", code)
              .single();

            if (error || !data) {
              alert("Session not found. Please check the code.");
              return;
            }

            const participantId = crypto.randomUUID();
            const updatedParticipants = [
              ...data.data.participants,
              { id: participantId, name: userName, isHost: false },
            ];

            const updatedData = {
              ...data.data,
              participants: updatedParticipants,
            };

            await supabase
              .from("session_data")
              .update({ data: updatedData })
              .eq("session_id", code);

            setSessionId(code);
            setIsHost(false);
            setIsCollaborative(true);
            setParticipants(updatedParticipants);

            // Sync local state with session
            setCurrentPhase(data.data.currentPhase);
            setChallenge(data.data.challenge);
            setIdeas(data.data.allIdeas);
            setSelectedIdeas(data.data.selectedIdeas);
            setPrototype(data.data.prototype);
            setPrototypeImages(data.data.prototypeImages || []);
            setHmwStatement(data.data.hmwStatement);
            setIterationNotes(data.data.iterationNotes);
            setTimerDuration(data.data.timerDuration);

            if (data.data.challenge) {
              setGameState("playing");
              setGameMode("collaborative");
            }
          } catch (error) {
            console.error("Error joining session:", error);
            alert("Failed to join session. Please try again.");
          }
        };

        const updateSessionData = async (updates) => {
          if (!sessionId || !supabase) return;

          try {
            const { data: current } = await supabase
              .from("session_data")
              .select("data")
              .eq("session_id", sessionId)
              .single();

            const updatedData = { ...current.data, ...updates };

            await supabase
              .from("session_data")
              .update({ data: updatedData })
              .eq("session_id", sessionId);
          } catch (error) {
            console.error("Error updating session:", error);
          }
        };

        const addIdeaToSession = async (idea) => {
          const newIdea = {
            id: crypto.randomUUID(),
            text: idea,
            author: userName,
            timestamp: new Date().toISOString(),
          };

          const updatedIdeas = [...ideas, newIdea];
          setIdeas(updatedIdeas);

          if (isCollaborative) {
            await updateSessionData({ allIdeas: updatedIdeas });
          }
        };

        // Real-time subscription effect
        useEffect(() => {
          if (!sessionId || !supabase) return;

          const subscription = supabase
            .channel("session_changes")
            .on(
              "postgres_changes",
              {
                event: "UPDATE",
                schema: "public",
                table: "session_data",
                filter: `session_id=eq.${sessionId}`,
              },
              (payload) => {
                const data = payload.new.data;

                // Always sync phase, gameState, and other critical state
                setCurrentPhase(data.currentPhase);
                setChallenge(data.challenge);
                setIdeas(data.allIdeas || []);
                setSelectedIdeas(data.selectedIdeas || []);
                setPrototype(data.prototype);
                setPrototypeImages(data.prototypeImages || []);
                setHmwStatement(data.hmwStatement || "");
                setIterationNotes(data.iterationNotes || "");
                setParticipants(data.participants || []);
                setTimerActive(data.timerActive || false);
                setTimer(data.timer || timerDuration);
                if (data.gameState) {
                  setGameState(data.gameState);
                }
                if (data.collaborativeScore !== undefined) {
                  setScore(data.collaborativeScore);
                }
              },
            )
            .subscribe();

          return () => subscription.unsubscribe();
        }, [sessionId, isHost, ideas.length, timerDuration]);

        const startGame = (mode) => {
          if (mode === "team" && (!teamName || teamMembers.length === 0)) {
            alert("Please enter a team name and add at least one team member");
            return;
          }

          if (mode === "collaborative" && !isHost) {
            alert("Only the host can start the game");
            return;
          }

          const enabled = getEnabledChallenges();
          if (enabled.length === 0) {
            alert(
              "Please enable at least one challenge in settings before starting",
            );
            return;
          }

          const randomChallenge =
            enabled[Math.floor(Math.random() * enabled.length)];
          setChallenge(randomChallenge);
          setGameMode(mode);
          setGameState("playing");
          setCurrentPhase(0);
          setIdeas([]);
          setSelectedIdeas([]);
          setPrototype(null);
          setPrototypeImages([]);
          setHmwStatement("");
          setIterationNotes("");
          setScore(0);
          setTimer(timerDuration);

          // Update session data for collaborative mode
          if (mode === "collaborative" && isCollaborative) {
            updateSessionData({
              challenge: randomChallenge,
              currentPhase: 0,
              allIdeas: [],
              selectedIdeas: [],
              prototype: null,
              prototypeImages: [],
              hmwStatement: "",
              iterationNotes: "",
              timer: timerDuration,
            });
          }
        };

        const handleSubmit = async () => {
          if (currentPhase === 0) {
            if (userInput.toLowerCase().includes("how might we")) {
              setHmwStatement(userInput);
              const newScore = score + 20;
              setScore(newScore);
              setUserInput("");

              if (isCollaborative) {
                setCurrentPhase(1);
                await updateSessionData({ 
                  hmwStatement: userInput,
                  currentPhase: 1,
                  timerActive: false,
                  collaborativeScore: newScore
                });
              } else {
                nextPhase();
              }
            } else {
              alert("Try starting with 'How might we...'");
            }
          } else if (currentPhase === 1) {
            if (userInput.trim()) {
              if (isCollaborative) {
                const newScore = score + 5;
                setScore(newScore);
                await addIdeaToSession(userInput.trim());
                await updateSessionData({ collaborativeScore: newScore });
              } else {
                const newIdea =
                  gameMode === "team" && playerName
                    ? `${userInput.trim()} [by ${playerName}]`
                    : userInput.trim();
                setIdeas([...ideas, newIdea]);
              }
              setScore(score + 5);
              setUserInput("");
            }
          } else if (currentPhase === 3) {
            if (userInput.trim().length > 20) {
              setPrototype(userInput);
              const newScore = score + 30;
              setScore(newScore);
              setUserInput("");
              
              if (isCollaborative) {
                setCurrentPhase(4);
                await updateSessionData({ 
                  prototype: userInput,
                  currentPhase: 4,
                  timerActive: false,
                  collaborativeScore: newScore
                });
              } else {
                nextPhase();
              }
            } else {
              alert("Describe your prototype in more detail!");
            }
          } else if (currentPhase === 4) {
            if (userInput.trim().length > 15) {
              setIterationNotes(userInput);
              const newScore = score + 25;
              setScore(newScore);
              setGameState("complete");

              if (isCollaborative) {
                await updateSessionData({ 
                  iterationNotes: userInput,
                  gameState: "complete",
                  collaborativeScore: newScore
                });
              }
            } else {
              alert("Share more thoughts on how to improve!");
            }
          }
        };

        const nextPhase = async () => {
          let newPhase = currentPhase;

          if (currentPhase === 1 && ideas.length >= 5) {
            newPhase = 2;
            setTimerActive(false);
          } else if (currentPhase === 2 && selectedIdeas.length === 3) {
            newPhase = 3;
          } else if (currentPhase < phases.length - 1) {
            newPhase = currentPhase + 1;
          }

          setCurrentPhase(newPhase);

          // Update session data for collaborative mode (only host can advance phases)
          if (isCollaborative && isHost) {
            await updateSessionData({
              currentPhase: newPhase,
              timerActive: false,
            });
          }
        };

        const toggleIdeaSelection = async (idea) => {
          let newSelectedIdeas;
          const ideaId = typeof idea === 'object' ? idea.id : idea;
          
          const isAlreadySelected = selectedIdeas.some(selected => 
            typeof selected === 'object' ? selected.id === ideaId : selected === ideaId
          );

          if (isAlreadySelected) {
            newSelectedIdeas = selectedIdeas.filter((i) => {
              const iId = typeof i === 'object' ? i.id : i;
              return iId !== ideaId;
            });
          } else if (selectedIdeas.length < 3) {
            newSelectedIdeas = [...selectedIdeas, idea];
            if (selectedIdeas.length === 2) {
              const newScore = score + 20;
              setScore(newScore);
              if (isCollaborative) {
                await updateSessionData({ 
                  selectedIdeas: newSelectedIdeas,
                  collaborativeScore: newScore
                });
                return;
              }
            }
          } else {
            return;
          }

          setSelectedIdeas(newSelectedIdeas);

          if (isCollaborative) {
            await updateSessionData({ selectedIdeas: newSelectedIdeas });
          }
        };

        const handleImageUpload = (event) => {
          try {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            const file = files[0];

            // Validate file exists
            if (!file) {
              alert("No file selected. Please try again.");
              event.target.value = "";
              return;
            }

            // Validate file type
            const validTypes = [
              "image/png",
              "image/jpg",
              "image/jpeg",
              "image/gif",
              "image/svg+xml",
            ];
            if (!validTypes.includes(file.type)) {
              alert(
                "Please upload an image file (PNG, JPG, JPEG, GIF, or SVG)",
              );
              event.target.value = "";
              return;
            }

            // Validate file size (max 5MB)
            const maxSize = 5 * 1024 * 1024; // 5MB in bytes
            if (file.size > maxSize) {
              alert(
                "Image file must be under 5MB. Please choose a smaller file.",
              );
              event.target.value = "";
              return;
            }

            // Check if already at max images
            if (prototypeImages.length >= 3) {
              alert(
                "Maximum 3 images allowed. Please remove an image before adding another.",
              );
              event.target.value = "";
              return;
            }

            // Read file and convert to base64
            const reader = new FileReader();

            reader.onload = (e) => {
              try {
                const result = e.target.result;
                if (!result) {
                  throw new Error("Failed to read image data");
                }
                setPrototypeImages([...prototypeImages, result]);
                event.target.value = ""; // Reset input
              } catch (error) {
                console.error("Error processing image:", error);
                alert("Failed to process image. Please try a different file.");
                event.target.value = "";
              }
            };

            reader.onerror = (error) => {
              console.error("FileReader error:", error);
              alert(
                "Error reading file. Please try again with a different file.",
              );
              event.target.value = "";
            };

            reader.readAsDataURL(file);
          } catch (error) {
            console.error("Error in handleImageUpload:", error);
            alert(
              "An unexpected error occurred while uploading the image. Please try again.",
            );
            if (event.target) {
              event.target.value = "";
            }
          }
        };

        const removeImage = (index) => {
          try {
            if (
              typeof index !== "number" ||
              index < 0 ||
              index >= prototypeImages.length
            ) {
              console.error("Invalid image index:", index);
              return;
            }
            setPrototypeImages(prototypeImages.filter((_, i) => i !== index));
          } catch (error) {
            console.error("Error removing image:", error);
            alert("Failed to remove image. Please try again.");
          }
        };

        const startTimer = async () => {
          setTimerActive(true);
          
          if (isCollaborative && isHost) {
            await updateSessionData({ 
              timerActive: true,
              timer: timer
            });
          }
          
          const interval = setInterval(async () => {
            setTimer((prev) => {
              const newTimer = prev <= 1 ? 0 : prev - 1;
              
              if (newTimer === 0) {
                clearInterval(interval);
                setTimerActive(false);
                if (ideas.length >= 5) {
                  nextPhase();
                }
              }
              
              // Sync timer every second in collaborative mode (host only)
              if (isCollaborative && isHost && newTimer > 0) {
                updateSessionData({ timer: newTimer });
              }
              
              return newTimer;
            });
          }, 1000);
        };

        const addTeamMember = () => {
          if (playerName.trim() && !teamMembers.includes(playerName.trim())) {
            setTeamMembers([...teamMembers, playerName.trim()]);
            setPlayerName("");
          }
        };

        const removeTeamMember = (member) => {
          setTeamMembers(teamMembers.filter((m) => m !== member));
        };

        const handleCustomTimerInput = (value) => {
          setCustomTimerInput(value);
          setTimerError("");

          if (value === "") {
            return;
          }

          const numValue = parseInt(value, 10);

          if (isNaN(numValue)) {
            setTimerError("Please enter a valid number of seconds");
            return;
          }

          if (numValue < 30 || numValue > 1800) {
            setTimerError(
              "Timer duration must be between 30 seconds and 30 minutes",
            );
            return;
          }

          setTimerDuration(numValue);
        };

        const downloadResults = () => {
          try {
            if (!challenge) {
              alert(
                "No results to download. Please complete a design sprint first.",
              );
              return;
            }

            const content = `
IDEO DESIGN SPRINT RESULTS
========================

${gameMode === "team" ? `Team: ${teamName}` : "Solo Sprint"}
${gameMode === "team" ? `Members: ${teamMembers.join(", ")}` : ""}
Challenge: ${challenge.title} (${challenge.topic})
Date: ${new Date().toLocaleDateString()}
Score: ${score} points

HOW MIGHT WE STATEMENT
${hmwStatement}

IDEAS GENERATED (${ideas.length} total)
${ideas.map((idea, i) => {
  const ideaText = typeof idea === 'object' ? idea.text : idea;
  const ideaAuthor = typeof idea === 'object' ? ` (by ${idea.author})` : '';
  return `${i + 1}. ${ideaText}${ideaAuthor}`;
}).join("\n")}

TOP 3 SELECTED IDEAS
${selectedIdeas.map((idea, i) => {
  const ideaText = typeof idea === 'object' ? idea.text : idea;
  return `${i + 1}. ${ideaText}`;
}).join("\n")}

PROTOTYPE
${prototype}
${prototypeImages.length > 0 ? `\n[Note: ${prototypeImages.length} image(s) attached - see PDF export for visuals]` : ""}

ITERATION & REFLECTION
${iterationNotes}

---
Generated by IDEO Design Sprint Game
                `.trim();

            const blob = new Blob([content], { type: "text/plain" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            const sanitizedTeamName = (teamName || "solo").replace(
              /[^a-z0-9]/gi,
              "-",
            );
            a.download = `design-sprint-${sanitizedTeamName}-${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
          } catch (error) {
            console.error("Error downloading results:", error);
            alert(
              "Failed to download results. Please try copying to clipboard instead.",
            );
          }
        };

        const copyToClipboard = () => {
          try {
            if (!challenge) {
              alert(
                "No results to copy. Please complete a design sprint first.",
              );
              return;
            }

            const text = `🎨 IDEO Design Sprint Results

${gameMode === "team" ? `👥 Team: ${teamName}` : "🧑 Solo Sprint"}
🎯 Challenge: ${challenge.title} (${challenge.topic})
⭐ Score: ${score} points
💡 Ideas Generated: ${ideas.length}

Top Concept: ${selectedIdeas[0] || "N/A"}`;

            if (!navigator.clipboard) {
              // Fallback for browsers that don't support clipboard API
              const textArea = document.createElement("textarea");
              textArea.value = text;
              textArea.style.position = "fixed";
              textArea.style.left = "-999999px";
              document.body.appendChild(textArea);
              textArea.select();
              try {
                document.execCommand("copy");
                alert("Results copied to clipboard!");
              } catch (err) {
                console.error("Fallback copy failed:", err);
                alert(
                  "Failed to copy to clipboard. Please try downloading results instead.",
                );
              }
              document.body.removeChild(textArea);
              return;
            }

            navigator.clipboard
              .writeText(text)
              .then(() => {
                alert("Results copied to clipboard!");
              })
              .catch((error) => {
                console.error("Error copying to clipboard:", error);
                alert(
                  "Failed to copy to clipboard. Please try downloading results instead.",
                );
              });
          } catch (error) {
            console.error("Error in copyToClipboard:", error);
            alert(
              "Failed to copy to clipboard. Please try downloading results instead.",
            );
          }
        };

        const downloadPDF = () => {
          try {
            // Check if jsPDF is available
            if (!window.jspdf || !window.jspdf.jsPDF) {
              alert(
                "PDF library not loaded. Please refresh the page and try again.",
              );
              return;
            }

            // Validate required data
            if (!challenge) {
              alert(
                "No challenge data available. Please complete a design sprint first.",
              );
              return;
            }

            // Access jsPDF from the global window object
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
              orientation: "portrait",
              unit: "mm",
              format: "a4",
            });

            const pageWidth = 210; // A4 width in mm
            const pageHeight = 297; // A4 height in mm
            const margin = 20;
            const contentWidth = pageWidth - 2 * margin;
            let yPosition = margin;

            // Color palette
            const colors = {
              purple: [147, 51, 234], // #9333EA
              gold: [234, 179, 8], // #EAB308
              darkGray: [31, 41, 55], // #1F2937
              mediumGray: [107, 114, 128], // #6B7280
              lightGray: [243, 244, 246], // #F3F4F6
              blue: [59, 130, 246], // #3B82F6
              green: [34, 197, 94], // #22C55E
              pink: [236, 72, 153], // #EC4899
            };

            // Helper function to draw a trophy/badge icon
            const drawTrophyBadge = (x, y, size) => {
              const centerX = x + size / 2;
              const centerY = y + size / 2;
              const radius = size / 2;

              // Draw gold circle
              doc.setFillColor(...colors.gold);
              doc.circle(centerX, centerY, radius, "F");

              // Draw checkmark
              doc.setLineWidth(2);
              doc.setDrawColor(255, 255, 255);
              doc.line(
                centerX - radius * 0.3,
                centerY,
                centerX - radius * 0.1,
                centerY + radius * 0.3,
              );
              doc.line(
                centerX - radius * 0.1,
                centerY + radius * 0.3,
                centerX + radius * 0.4,
                centerY - radius * 0.3,
              );
            };

            // Helper function to add text with word wrapping
            const addText = (
              text,
              fontSize,
              isBold = false,
              color = colors.darkGray,
              align = "left",
            ) => {
              doc.setFontSize(fontSize);
              doc.setFont("helvetica", isBold ? "bold" : "normal");
              doc.setTextColor(...color);

              const lines = doc.splitTextToSize(text, contentWidth);

              // Check if we need a new page
              if (
                yPosition + lines.length * fontSize * 0.35 >
                pageHeight - margin
              ) {
                doc.addPage();
                yPosition = margin;
              }

              if (align === "center") {
                lines.forEach((line) => {
                  const textWidth = doc.getTextWidth(line);
                  doc.text(line, (pageWidth - textWidth) / 2, yPosition);
                  yPosition += fontSize * 0.35;
                });
              } else {
                doc.text(lines, margin, yPosition);
                yPosition += lines.length * fontSize * 0.35;
              }
            };

            // Helper function to add spacing
            const addSpacing = (space = 5) => {
              yPosition += space;
            };

            // Helper function to draw a colored box background
            const drawBox = (height, color, opacity = 0.1) => {
              if (yPosition + height > pageHeight - margin) {
                doc.addPage();
                yPosition = margin;
              }
              doc.setFillColor(...color);
              doc.setGState(new doc.GState({ opacity: opacity }));
              doc.roundedRect(
                margin,
                yPosition,
                contentWidth,
                height,
                3,
                3,
                "F",
              );
              doc.setGState(new doc.GState({ opacity: 1 }));
            };

            // ===== COVER PAGE =====

            // Draw trophy badge at top center
            const badgeSize = 20;
            drawTrophyBadge((pageWidth - badgeSize) / 2, yPosition, badgeSize);
            yPosition += badgeSize + 8;

            // Title
            addText(
              "Design Sprint Complete!",
              18,
              true,
              colors.darkGray,
              "center",
            );
            addSpacing(5);

            // Score - large and centered
            addText(`${score} points`, 32, true, colors.purple, "center");
            addSpacing(10);

            // "Your Design Journey" section header
            addText("Your Design Journey", 14, true, colors.darkGray);
            addSpacing(5);

            // Challenge box
            const challengeBoxHeight = 25;
            drawBox(challengeBoxHeight, colors.lightGray, 0.5);
            yPosition += 7;
            addText(`Challenge: ${challenge.title}`, 12, true, colors.darkGray);
            addText(`Topic: ${challenge.topic}`, 10, false, colors.mediumGray);
            yPosition += challengeBoxHeight - 12;
            addSpacing(8);

            // Team info (if applicable)
            if (gameMode === "team") {
              const teamBoxHeight = teamMembers.length > 0 ? 25 : 15;
              drawBox(teamBoxHeight, colors.purple, 0.1);
              yPosition += 5;
              addText(`Team: ${teamName}`, 11, true, colors.purple);
              if (teamMembers.length > 0) {
                addText(
                  `Members: ${teamMembers.join(", ")}`,
                  10,
                  false,
                  colors.mediumGray,
                );
              }
              yPosition += teamBoxHeight - (teamMembers.length > 0 ? 15 : 10);
              addSpacing(8);
            }

            // Date
            const currentDate = new Date().toLocaleDateString("en-US", {
              year: "numeric",
              month: "long",
              day: "numeric",
            });
            addText(currentDate, 10, false, colors.mediumGray);
            addSpacing(15);

            // ===== HMW STATEMENT =====
            addText("How Might We:", 14, true, colors.blue);
            addSpacing(3);

            const hmwLines = doc.splitTextToSize(
              hmwStatement,
              contentWidth - 10,
            );
            const hmwBoxHeight = Math.max(20, hmwLines.length * 4 + 10);
            drawBox(hmwBoxHeight, colors.blue, 0.1);
            yPosition += 6;
            addText(hmwStatement, 11, false, colors.darkGray);
            yPosition += hmwBoxHeight - (hmwLines.length * 4 + 6);
            addSpacing(10);

            // ===== IDEAS GENERATED =====
            addText(`Ideas Generated: ${ideas.length}`, 14, true, colors.gold);
            addSpacing(5);

            ideas.forEach((idea, index) => {
              const ideaText = `${index + 1}. ${idea}`;
              const ideaLines = doc.splitTextToSize(ideaText, contentWidth - 5);
              const ideaBoxHeight = ideaLines.length * 4 + 6;

              if (yPosition + ideaBoxHeight > pageHeight - margin) {
                doc.addPage();
                yPosition = margin;
              }

              drawBox(ideaBoxHeight, colors.gold, 0.05);
              yPosition += 4;
              addText(ideaText, 9, false, colors.darkGray);
              yPosition += ideaBoxHeight - 4;
              addSpacing(2);
            });
            addSpacing(8);

            // ===== TOP 3 SELECTED IDEAS =====
            addText("Top 3 Selected Ideas", 14, true, colors.green);
            addSpacing(5);

            selectedIdeas.forEach((idea, index) => {
              const selectedText = `${index + 1}. ${idea}`;
              const selectedLines = doc.splitTextToSize(
                selectedText,
                contentWidth - 5,
              );
              const selectedBoxHeight = selectedLines.length * 4 + 8;

              if (yPosition + selectedBoxHeight > pageHeight - margin) {
                doc.addPage();
                yPosition = margin;
              }

              drawBox(selectedBoxHeight, colors.green, 0.1);
              yPosition += 5;
              addText(selectedText, 10, true, colors.darkGray);
              yPosition += selectedBoxHeight - 5;
              addSpacing(3);
            });
            addSpacing(10);

            // ===== PROTOTYPE =====
            addText("Your Prototype", 14, true, colors.purple);
            addSpacing(5);

            const prototypeLines = doc.splitTextToSize(
              prototype,
              contentWidth - 10,
            );
            const prototypeBoxHeight = prototypeLines.length * 4 + 10;
            drawBox(prototypeBoxHeight, colors.purple, 0.1);
            yPosition += 6;
            addText(prototype, 10, false, colors.darkGray);
            yPosition += prototypeBoxHeight - (prototypeLines.length * 4 + 6);
            addSpacing(10);

            // ===== PROTOTYPE IMAGES =====
            if (prototypeImages.length > 0) {
              addText("Prototype Images", 14, true, colors.purple);
              addSpacing(5);

              prototypeImages.forEach((imgData, index) => {
                const imgHeight = 80;
                if (yPosition + imgHeight > pageHeight - margin) {
                  doc.addPage();
                  yPosition = margin;
                }

                try {
                  let format = "JPEG";
                  if (imgData.includes("image/png")) {
                    format = "PNG";
                  } else if (
                    imgData.includes("image/jpeg") ||
                    imgData.includes("image/jpg")
                  ) {
                    format = "JPEG";
                  } else if (imgData.includes("image/gif")) {
                    format = "GIF";
                  }

                  const maxImgWidth = contentWidth - 10;
                  doc.addImage(
                    imgData,
                    format,
                    margin + 5,
                    yPosition,
                    maxImgWidth,
                    0,
                  );
                  yPosition += 70;
                  addSpacing(5);
                } catch (error) {
                  console.error("Error adding image to PDF:", error);
                  addText(
                    `[Image ${index + 1} could not be embedded]`,
                    10,
                    false,
                    colors.mediumGray,
                  );
                }
              });
              addSpacing(5);
            }

            // ===== ITERATION & REFLECTION =====
            addText("Iteration & Reflection", 14, true, colors.pink);
            addSpacing(5);

            const iterationLines = doc.splitTextToSize(
              iterationNotes,
              contentWidth - 10,
            );
            const iterationBoxHeight = iterationLines.length * 4 + 10;

            if (yPosition + iterationBoxHeight > pageHeight - margin) {
              doc.addPage();
              yPosition = margin;
            }

            drawBox(iterationBoxHeight, colors.pink, 0.1);
            yPosition += 6;
            addText(iterationNotes, 10, false, colors.darkGray);
            yPosition += iterationBoxHeight - (iterationLines.length * 4 + 6);

            // ===== FOOTER =====
            // Move to bottom of page
            yPosition = pageHeight - margin - 10;

            doc.setFontSize(8);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(...colors.mediumGray);
            doc.text(
              "Generated by IDEO Design Sprint Game",
              pageWidth / 2,
              yPosition,
              { align: "center" },
            );

            // Download the PDF
            try {
              const sanitizedTeamName = (teamName || "solo").replace(
                /[^a-z0-9]/gi,
                "-",
              );
              const filename = `design-sprint-${sanitizedTeamName}-${Date.now()}.pdf`;
              doc.save(filename);
            } catch (saveError) {
              console.error("Error saving PDF:", saveError);
              alert(
                "Failed to save PDF file. Please check your browser settings and try again.",
              );
            }
          } catch (error) {
            console.error("Error generating PDF:", error);
            alert(
              "Failed to generate PDF. Please try downloading as text file instead.",
            );
          }
        };

        const generateShareableResults = () => {
          return {
            teamName: gameMode === "team" ? teamName : "Solo Sprint",
            teamMembers: gameMode === "team" ? teamMembers : [],
            challenge: challenge.title,
            topic: challenge.topic,
            date: new Date().toLocaleDateString(),
            score: score,
            hmwStatement: hmwStatement,
            ideasCount: ideas.length,
            ideas: ideas,
            topIdeas: selectedIdeas,
            prototype: prototype,
            prototypeImagesCount: prototypeImages.length,
            iterationNotes: iterationNotes,
          };
        };

        const openEmailModal = () => {
          // Pre-fill subject line with challenge title
          setEmailForm({
            recipients: "",
            subject: `Design Sprint Results - ${challenge.title}`,
            message: "",
          });
          setShowEmailModal(true);
        };

        const formatEmailBody = () => {
          const results = generateShareableResults();

          let body = `Hi,\n\n`;
          body += `Here are the results from our IDEO Design Sprint:\n\n`;
          body += `Challenge: ${results.challenge} (${results.topic})\n`;
          body += `${gameMode === "team" ? `Team: ${results.teamName}` : "Solo Sprint"}\n`;
          if (gameMode === "team" && results.teamMembers.length > 0) {
            body += `Members: ${results.teamMembers.join(", ")}\n`;
          }
          body += `Date: ${results.date}\n`;
          body += `Score: ${results.score} points\n\n`;

          body += `HOW MIGHT WE:\n${results.hmwStatement}\n\n`;

          body += `TOP 3 IDEAS:\n`;
          results.topIdeas.forEach((idea, idx) => {
            body += `${idx + 1}. ${idea}\n`;
          });
          body += `\n`;

          body += `PROTOTYPE:\n${results.prototype}\n\n`;

          if (results.prototypeImagesCount > 0) {
            body += `[Note: ${results.prototypeImagesCount} image(s) attached separately]\n\n`;
          }

          body += `NEXT STEPS:\n${results.iterationNotes}\n\n`;

          body += `---\nGenerated by IDEO Design Sprint Game`;

          return body;
        };

        const openEmailClient = () => {
          try {
            // Validate challenge data exists
            if (!challenge) {
              alert(
                "No results to email. Please complete a design sprint first.",
              );
              return;
            }

            // Validate email form inputs
            if (!emailForm.recipients || !emailForm.recipients.trim()) {
              alert("Please enter at least one recipient email address");
              return;
            }

            // Basic email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            const recipients = emailForm.recipients
              .split(",")
              .map((e) => e.trim())
              .filter((e) => e);

            if (recipients.length === 0) {
              alert("Please enter at least one valid recipient email address");
              return;
            }

            const invalidEmails = recipients.filter(
              (email) => !emailRegex.test(email),
            );

            if (invalidEmails.length > 0) {
              alert(
                `Invalid email address(es): ${invalidEmails.join(", ")}\n\nPlease use format: email@example.com`,
              );
              return;
            }

            // Validate subject
            if (!emailForm.subject || !emailForm.subject.trim()) {
              alert("Please enter an email subject");
              return;
            }

            // Format email body
            let emailBody;
            try {
              emailBody = formatEmailBody();
            } catch (error) {
              console.error("Error formatting email body:", error);
              alert(
                "Failed to format email content. Please try downloading results instead.",
              );
              return;
            }

            // Add optional message if provided
            if (emailForm.message && emailForm.message.trim()) {
              emailBody = `${emailForm.message.trim()}\n\n${emailBody}`;
            }

            // Construct mailto URL with encoded parameters
            try {
              const subject = encodeURIComponent(emailForm.subject.trim());
              const body = encodeURIComponent(emailBody);
              const to = encodeURIComponent(emailForm.recipients.trim());

              // Check if mailto URL is too long (some email clients have limits)
              const mailtoUrl = `mailto:${to}?subject=${subject}&body=${body}`;

              if (mailtoUrl.length > 2000) {
                alert(
                  "Email content is too long for some email clients. Please try downloading results as a file instead.",
                );
                return;
              }

              // Open mailto URL in new window
              window.open(mailtoUrl, "_blank");

              // Close email modal and show confirmation
              setShowEmailModal(false);
              alert(
                "Email client opened! Please manually attach any prototype images if needed.",
              );
            } catch (error) {
              console.error("Error creating mailto URL:", error);
              alert(
                "Failed to open email client. Please try copying results to clipboard instead.",
              );
            }
          } catch (error) {
            console.error("Error in openEmailClient:", error);
            alert(
              "An unexpected error occurred. Please try downloading results instead.",
            );
          }
        };

        // Intro Screen (truncated for brevity - full component continues...)
        if (gameState === "intro") {
          return (
            <div className="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 p-8">
              <div className="max-w-6xl mx-auto">
                <div className="bg-white rounded-2xl shadow-2xl p-12">
                  <div className="flex justify-between items-start mb-8">
                    <div className="text-center flex-1">
                      <Icons.Sparkles className="w-20 h-20 mx-auto mb-4 text-yellow-500" />
                      <h1 className="text-5xl font-bold mb-4 text-gray-800">
                        IDEO Design Sprint
                      </h1>
                      <p className="text-xl text-gray-600">
                        Learn Design Thinking Through Play
                      </p>
                    </div>
                    <button
                      onClick={() => setShowSettings(true)}
                      className="p-3 hover:bg-gray-100 rounded-lg transition-all"
                    >
                      <Icons.Settings className="w-6 h-6 text-gray-600" />
                    </button>
                  </div>

                  {!gameMode && !isCollaborative ? (
                    <div className="grid md:grid-cols-3 gap-6 mb-8">
                      <div
                        onClick={() => setGameMode("solo")}
                        className="bg-gradient-to-br from-blue-50 to-blue-100 p-8 rounded-xl cursor-pointer hover:shadow-lg transition-all border-2 border-blue-200 hover:border-blue-400"
                      >
                        <div className="text-center">
                          <Icons.Users className="w-16 h-16 mx-auto mb-4 text-blue-600" />
                          <h3 className="font-bold text-2xl mb-3 text-blue-800">
                            Solo Mode
                          </h3>
                          <p className="text-gray-700">
                            Practice design thinking on your own
                          </p>
                        </div>
                      </div>

                      <div
                        onClick={() => setGameMode("team")}
                        className="bg-gradient-to-br from-purple-50 to-purple-100 p-8 rounded-xl cursor-pointer hover:shadow-lg transition-all border-2 border-purple-200 hover:border-purple-400"
                      >
                        <div className="text-center">
                          <Icons.Users className="w-16 h-16 mx-auto mb-4 text-purple-600" />
                          <h3 className="font-bold text-2xl mb-3 text-purple-800">
                            Team Mode
                          </h3>
                          <p className="text-gray-700">
                            Collaborate with your team in real-time
                          </p>
                        </div>
                      </div>

                      <div
                        onClick={() => setGameMode("collaborative")}
                        className="bg-gradient-to-br from-green-50 to-green-100 p-8 rounded-xl cursor-pointer hover:shadow-lg transition-all border-2 border-green-200 hover:border-green-400"
                      >
                        <div className="text-center">
                          <Icons.Users className="w-16 h-16 mx-auto mb-4 text-green-600" />
                          <h3 className="font-bold text-2xl mb-3 text-green-800">
                            Collaborative
                          </h3>
                          <p className="text-gray-700">
                            Real-time collaboration with remote participants
                          </p>
                        </div>
                      </div>
                    </div>
                  ) : null}

                  {gameMode === "team" && (
                    <div className="bg-purple-50 rounded-xl p-6 mb-8">
                      <h3 className="font-bold text-xl mb-4 text-purple-800">
                        Team Setup
                      </h3>

                      <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Team Name
                        </label>
                        <input
                          type="text"
                          value={teamName}
                          onChange={(e) => setTeamName(e.target.value)}
                          placeholder="e.g., Innovation Squad"
                          className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none"
                        />
                      </div>

                      <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Add Team Members
                        </label>
                        <div className="flex gap-2">
                          <input
                            type="text"
                            value={playerName}
                            onChange={(e) => setPlayerName(e.target.value)}
                            onKeyPress={(e) =>
                              e.key === "Enter" && addTeamMember()
                            }
                            placeholder="Enter name"
                            className="flex-1 p-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none"
                          />
                          <button
                            onClick={addTeamMember}
                            className="bg-purple-500 text-white px-6 py-3 rounded-lg font-bold hover:bg-purple-600 transition-all"
                          >
                            <Icons.Plus className="w-5 h-5" />
                          </button>
                        </div>
                      </div>

                      {teamMembers.length > 0 && (
                        <div className="flex flex-wrap gap-2">
                          {teamMembers.map((member, idx) => (
                            <div
                              key={idx}
                              className="bg-white px-4 py-2 rounded-full flex items-center gap-2 border-2 border-purple-200"
                            >
                              <span className="text-gray-700">{member}</span>
                              <button
                                onClick={() => removeTeamMember(member)}
                                className="text-red-500 hover:text-red-700"
                              >
                                <Icons.X className="w-4 h-4" />
                              </button>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  )}

                  {gameMode === "collaborative" && !isCollaborative && (
                    <div className="bg-green-50 rounded-xl p-6 mb-8">
                      <h3 className="font-bold text-xl mb-4 text-green-800">
                        Collaborative Session Setup
                      </h3>

                      <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Your Name
                        </label>
                        <input
                          type="text"
                          value={userName}
                          onChange={(e) => setUserName(e.target.value)}
                          placeholder="Enter your name"
                          className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:outline-none"
                        />
                      </div>

                      <div className="grid md:grid-cols-2 gap-4">
                        <button
                          onClick={createSession}
                          disabled={!userName.trim()}
                          className="bg-green-500 text-white px-6 py-3 rounded-lg font-bold hover:bg-green-600 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                          Create Session
                        </button>

                        <div className="flex gap-2">
                          <input
                            type="text"
                            value={joinCode}
                            onChange={(e) => setJoinCode(e.target.value)}
                            placeholder="Session code"
                            className="flex-1 p-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:outline-none"
                          />
                          <button
                            onClick={() => joinSession(joinCode)}
                            disabled={!userName.trim() || !joinCode.trim()}
                            className="bg-blue-500 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-600 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                          >
                            Join
                          </button>
                        </div>
                      </div>
                    </div>
                  )}

                  {isCollaborative && (
                    <div className="bg-green-50 rounded-xl p-6 mb-8">
                      <h3 className="font-bold text-xl mb-4 text-green-800">
                        Session: {sessionId}
                      </h3>

                      <div className="mb-4">
                        <h4 className="font-semibold text-gray-700 mb-2">
                          Participants ({participants.length})
                        </h4>
                        <div className="flex flex-wrap gap-2">
                          {participants.map((participant) => (
                            <div
                              key={participant.id}
                              className={`px-3 py-1 rounded-full text-sm ${
                                participant.isHost
                                  ? "bg-green-200 text-green-800"
                                  : "bg-gray-200 text-gray-700"
                              }`}
                            >
                              {participant.name}{" "}
                              {participant.isHost && "(Host)"}
                            </div>
                          ))}
                        </div>
                      </div>

                      {isHost && (
                        <p className="text-sm text-green-700">
                          Share this session code with participants:{" "}
                          <strong>{sessionId}</strong>
                        </p>
                      )}
                    </div>
                  )}

                  <div className="flex gap-4 justify-center mb-6">
                    <div className="flex items-center gap-2 bg-gray-100 px-4 py-2 rounded-lg">
                      <Icons.Clock className="w-5 h-5 text-gray-600" />
                      <span className="text-gray-700">15-20 min</span>
                    </div>
                    <div className="flex items-center gap-2 bg-gray-100 px-4 py-2 rounded-lg">
                      <Icons.Trophy className="w-5 h-5 text-gray-600" />
                      <span className="text-gray-700">100+ points</span>
                    </div>
                  </div>

                  {enabledChallenges.size === 0 && (
                    <div className="bg-yellow-50 border-2 border-yellow-200 rounded-xl p-4 mb-4">
                      <p className="text-yellow-800 font-semibold">
                        ⚠️ No challenges enabled
                      </p>
                      <p className="text-yellow-700 text-sm">
                        Please enable at least one challenge in settings before
                        starting.
                      </p>
                    </div>
                  )}

                  <div className="flex gap-4">
                    {gameMode && (
                      <button
                        onClick={() => setGameMode(null)}
                        className="flex-1 bg-gray-200 text-gray-700 py-4 rounded-xl text-xl font-bold hover:bg-gray-300 transition-all"
                      >
                        ← Back
                      </button>
                    )}
                    <button
                      onClick={() => startGame(gameMode)}
                      disabled={
                        !gameMode ||
                        enabledChallenges.size === 0 ||
                        (gameMode === "collaborative" &&
                          (!isCollaborative || !isHost))
                      }
                      className="flex-1 bg-gradient-to-r from-blue-500 to-purple-500 text-white py-4 rounded-xl text-xl font-bold hover:from-blue-600 hover:to-purple-600 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      {gameMode === "collaborative" && !isHost
                        ? "Waiting for host to start..."
                        : "Start Design Sprint →"}
                    </button>
                  </div>
                </div>
              </div>

              {showSettings && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 overflow-y-auto">
                  <div className="bg-white rounded-2xl p-4 sm:p-6 md:p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto modal-content my-4">
                    <div className="flex justify-between items-center mb-4 sm:mb-6">
                      <h2 className="text-xl sm:text-2xl font-bold text-gray-800">
                        Facilitator Settings
                      </h2>
                      <button
                        onClick={() => setShowSettings(false)}
                        className="text-gray-500 hover:text-gray-700 p-2 hover:bg-gray-100 rounded-lg transition-all"
                        aria-label="Close settings"
                      >
                        <Icons.X className="w-6 h-6" />
                      </button>
                    </div>

                    <div className="mb-6">
                      <div className="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 mb-4">
                        <h3 className="font-bold text-base sm:text-lg text-gray-800">
                          Custom Challenges
                        </h3>
                        <div className="flex flex-wrap gap-2">
                          <button
                            onClick={() => setShowAddChallenge(true)}
                            className="bg-blue-500 text-white px-3 sm:px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-600 active:bg-blue-700 transition-all flex items-center gap-2"
                            aria-label="Add new challenge"
                          >
                            <Icons.Plus className="w-4 h-4" />
                            <span className="hidden sm:inline">
                              Add Challenge
                            </span>
                            <span className="sm:hidden">Add</span>
                          </button>
                          <label className="bg-purple-500 text-white px-3 sm:px-4 py-2 rounded-lg text-sm font-bold hover:bg-purple-600 active:bg-purple-700 transition-all flex items-center gap-2 cursor-pointer">
                            <Icons.Download className="w-4 h-4" />
                            <span className="hidden sm:inline">
                              Import Challenges
                            </span>
                            <span className="sm:hidden">Import</span>
                            <input
                              type="file"
                              accept=".json"
                              onChange={handleImportFile}
                              className="hidden"
                              aria-label="Import challenges from JSON file"
                            />
                          </label>
                          {customChallenges.length > 0 && (
                            <button
                              onClick={exportChallenges}
                              className="bg-green-500 text-white px-3 sm:px-4 py-2 rounded-lg text-sm font-bold hover:bg-green-600 active:bg-green-700 transition-all flex items-center gap-2"
                              aria-label="Export challenges to JSON file"
                            >
                              <Icons.Download className="w-4 h-4" />
                              <span className="hidden sm:inline">
                                Export Challenges
                              </span>
                              <span className="sm:hidden">Export</span>
                            </button>
                          )}
                        </div>
                      </div>

                      {showAddChallenge && (
                        <div className="bg-blue-50 p-4 rounded-lg mb-4 space-y-3">
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                              Challenge Title{" "}
                              <span className="text-red-500">*</span>
                            </label>
                            <input
                              type="text"
                              placeholder="e.g., Campus Coffee Crisis"
                              value={newChallenge.title}
                              onChange={(e) =>
                                setNewChallenge({
                                  ...newChallenge,
                                  title: e.target.value,
                                })
                              }
                              className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                              aria-required="true"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                              Challenge Description{" "}
                              <span className="text-red-500">*</span>
                            </label>
                            <textarea
                              placeholder="Describe the problem or situation..."
                              value={newChallenge.description}
                              onChange={(e) =>
                                setNewChallenge({
                                  ...newChallenge,
                                  description: e.target.value,
                                })
                              }
                              className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                              rows="3"
                              aria-required="true"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                              User Persona{" "}
                              <span className="text-red-500">*</span>
                            </label>
                            <input
                              type="text"
                              placeholder="e.g., Sarah, a sophomore juggling 18 credits"
                              value={newChallenge.persona}
                              onChange={(e) =>
                                setNewChallenge({
                                  ...newChallenge,
                                  persona: e.target.value,
                                })
                              }
                              className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                              aria-required="true"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                              Pain Point <span className="text-red-500">*</span>
                            </label>
                            <input
                              type="text"
                              placeholder="What's the main frustration or challenge?"
                              value={newChallenge.painPoint}
                              onChange={(e) =>
                                setNewChallenge({
                                  ...newChallenge,
                                  painPoint: e.target.value,
                                })
                              }
                              className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                              aria-required="true"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                              Topic <span className="text-red-500">*</span>
                            </label>
                            <select
                              value={
                                newChallenge.topic === "Custom" ||
                                !TOPICS.includes(newChallenge.topic)
                                  ? "Custom"
                                  : newChallenge.topic
                              }
                              onChange={(e) =>
                                setNewChallenge({
                                  ...newChallenge,
                                  topic: e.target.value,
                                })
                              }
                              className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                              aria-required="true"
                            >
                              <option value="">Select Topic</option>
                              {TOPICS.map((topic) => (
                                <option key={topic} value={topic}>
                                  {topic}
                                </option>
                              ))}
                            </select>
                          </div>
                          {(newChallenge.topic === "Custom" ||
                            (newChallenge.topic &&
                              !TOPICS.slice(0, -1).includes(
                                newChallenge.topic,
                              ))) && (
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">
                                Custom Topic Name{" "}
                                <span className="text-red-500">*</span>
                              </label>
                              <input
                                type="text"
                                placeholder="Enter custom topic name"
                                value={
                                  newChallenge.topic === "Custom"
                                    ? ""
                                    : newChallenge.topic
                                }
                                onChange={(e) =>
                                  setNewChallenge({
                                    ...newChallenge,
                                    topic: e.target.value,
                                  })
                                }
                                className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                                aria-required="true"
                              />
                            </div>
                          )}
                          <div className="flex gap-2 pt-2">
                            <button
                              onClick={addCustomChallenge}
                              className="flex-1 bg-green-500 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-600 active:bg-green-700 transition-all"
                            >
                              Save Challenge
                            </button>
                            <button
                              onClick={() => setShowAddChallenge(false)}
                              className="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg font-bold hover:bg-gray-400 active:bg-gray-500 transition-all"
                            >
                              Cancel
                            </button>
                          </div>
                        </div>
                      )}

                      <div className="space-y-2">
                        <p className="text-sm text-gray-600 mb-2">
                          {defaultChallenges.length} default challenges
                        </p>
                        {customChallenges.length > 0 ? (
                          customChallenges.map((c, idx) => (
                            <div
                              key={idx}
                              className="bg-gray-50 p-3 sm:p-4 rounded-lg hover:bg-gray-100 transition-all"
                            >
                              <div className="flex flex-wrap items-center gap-2 mb-2">
                                <div className="font-semibold text-gray-800 text-sm sm:text-base">
                                  {c.title}
                                </div>
                                <span
                                  className={`px-2 py-1 rounded-full text-xs font-semibold ${getTopicColor(c.topic)}`}
                                  role="status"
                                  aria-label={`Topic: ${c.topic}`}
                                >
                                  {c.topic}
                                </span>
                              </div>
                              <div className="text-xs sm:text-sm text-gray-600">
                                {c.description}
                              </div>
                            </div>
                          ))
                        ) : (
                          <p className="text-sm text-gray-500 italic text-center py-4">
                            No custom challenges yet. Click "Add Challenge" to
                            create one.
                          </p>
                        )}
                      </div>
                    </div>

                    <div className="mb-6 border-t pt-4 sm:pt-6">
                      <h3 className="font-bold text-base sm:text-lg text-gray-800 mb-3 sm:mb-4">
                        Challenge Selection
                      </h3>
                      <p className="text-xs sm:text-sm text-gray-600 mb-3 sm:mb-4">
                        Select which challenges will be available when starting
                        a sprint
                      </p>

                      <div className="flex flex-wrap gap-2 mb-4">
                        <button
                          onClick={selectAllChallenges}
                          className="bg-blue-500 text-white px-3 sm:px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-600 active:bg-blue-700 transition-all"
                          aria-label="Select all challenges"
                        >
                          Select All
                        </button>
                        <button
                          onClick={deselectAllChallenges}
                          className="bg-gray-300 text-gray-700 px-3 sm:px-4 py-2 rounded-lg text-sm font-bold hover:bg-gray-400 active:bg-gray-500 transition-all"
                          aria-label="Deselect all challenges"
                        >
                          Deselect All
                        </button>
                      </div>

                      <div className="space-y-2 max-h-64 overflow-y-auto border border-gray-200 rounded-lg p-2">
                        {allChallenges.map((challenge, idx) => (
                          <label
                            key={idx}
                            className="flex items-center gap-3 p-2 sm:p-3 hover:bg-gray-50 rounded-lg cursor-pointer transition-all"
                          >
                            <input
                              type="checkbox"
                              checked={enabledChallenges.has(challenge.title)}
                              onChange={() =>
                                toggleChallengeEnabled(challenge.title)
                              }
                              className="w-5 h-5 flex-shrink-0"
                              aria-label={`Enable ${challenge.title}`}
                            />
                            <div className="flex-1 min-w-0">
                              <div className="flex flex-wrap items-center gap-2">
                                <span className="text-gray-800 text-sm sm:text-base font-medium">
                                  {challenge.title}
                                </span>
                                <span
                                  className={`px-2 py-1 rounded-full text-xs font-semibold ${getTopicColor(challenge.topic)}`}
                                  role="status"
                                  aria-label={`Topic: ${challenge.topic}`}
                                >
                                  {challenge.topic}
                                </span>
                              </div>
                            </div>
                          </label>
                        ))}
                      </div>
                      <h3 className="font-bold text-base sm:text-lg text-gray-800 mb-3 sm:mb-4 mt-4 sm:mt-6">
                        Timer Settings
                      </h3>
                      <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                        <p className="text-xs sm:text-sm text-blue-800 font-medium">
                          Current Duration: {Math.floor(timerDuration / 60)}:
                          {(timerDuration % 60).toString().padStart(2, "0")}
                        </p>
                      </div>

                      <div className="grid grid-cols-2 sm:flex sm:flex-wrap gap-2 sm:gap-3 mb-4">
                        <button
                          onClick={() => {
                            setTimerDuration(60);
                            setCustomTimerInput("");
                            setTimerError("");
                          }}
                          className={`px-3 sm:px-4 py-2 rounded-lg font-semibold transition-all ${
                            timerDuration === 60 && customTimerInput === ""
                              ? "bg-blue-500 text-white shadow-md"
                              : "bg-gray-100 text-gray-700 hover:bg-gray-200 active:bg-gray-300"
                          }`}
                          aria-pressed={
                            timerDuration === 60 && customTimerInput === ""
                          }
                        >
                          1 min
                        </button>
                        <button
                          onClick={() => {
                            setTimerDuration(180);
                            setCustomTimerInput("");
                            setTimerError("");
                          }}
                          className={`px-3 sm:px-4 py-2 rounded-lg font-semibold transition-all ${
                            timerDuration === 180 && customTimerInput === ""
                              ? "bg-blue-500 text-white shadow-md"
                              : "bg-gray-100 text-gray-700 hover:bg-gray-200 active:bg-gray-300"
                          }`}
                          aria-pressed={
                            timerDuration === 180 && customTimerInput === ""
                          }
                        >
                          3 min
                        </button>
                        <button
                          onClick={() => {
                            setTimerDuration(300);
                            setCustomTimerInput("");
                            setTimerError("");
                          }}
                          className={`px-3 sm:px-4 py-2 rounded-lg font-semibold transition-all ${
                            timerDuration === 300 && customTimerInput === ""
                              ? "bg-blue-500 text-white shadow-md"
                              : "bg-gray-100 text-gray-700 hover:bg-gray-200 active:bg-gray-300"
                          }`}
                          aria-pressed={
                            timerDuration === 300 && customTimerInput === ""
                          }
                        >
                          5 min
                        </button>
                        <button
                          onClick={() => {
                            setTimerDuration(600);
                            setCustomTimerInput("");
                            setTimerError("");
                          }}
                          className={`px-3 sm:px-4 py-2 rounded-lg font-semibold transition-all ${
                            timerDuration === 600 && customTimerInput === ""
                              ? "bg-blue-500 text-white shadow-md"
                              : "bg-gray-100 text-gray-700 hover:bg-gray-200 active:bg-gray-300"
                          }`}
                          aria-pressed={
                            timerDuration === 600 && customTimerInput === ""
                          }
                        >
                          10 min
                        </button>
                      </div>

                      <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Custom Duration (seconds)
                        </label>
                        <input
                          type="number"
                          value={customTimerInput}
                          onChange={(e) =>
                            handleCustomTimerInput(e.target.value)
                          }
                          placeholder="Enter seconds (30-1800)"
                          min="30"
                          max="1800"
                          className={`w-full p-3 border-2 rounded-lg focus:outline-none transition-all ${
                            timerError
                              ? "border-red-500 focus:border-red-500 bg-red-50"
                              : "border-gray-300 focus:border-blue-500"
                          }`}
                          aria-invalid={!!timerError}
                          aria-describedby={
                            timerError ? "timer-error" : undefined
                          }
                        />
                        {timerError && (
                          <p
                            id="timer-error"
                            className="text-sm text-red-600 mt-2 flex items-center gap-1"
                            role="alert"
                          >
                            <span>⚠️</span>
                            {timerError}
                          </p>
                        )}
                      </div>

                      <div className="bg-gray-50 border border-gray-200 rounded-lg p-3">
                        <p className="text-xs text-gray-600 flex items-start gap-2">
                          <span className="text-base">ℹ️</span>
                          <span>
                            Timer settings apply to the current session only and
                            reset when the browser is closed.
                          </span>
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* Import Preview Modal */}
              {showImportPreview && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 overflow-y-auto">
                  <div className="bg-white rounded-2xl p-4 sm:p-6 md:p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto modal-content my-4">
                    <div className="flex justify-between items-center mb-4 sm:mb-6">
                      <h2 className="text-xl sm:text-2xl font-bold text-gray-800">
                        Import Challenges Preview
                      </h2>
                      <button
                        onClick={() => setShowImportPreview(false)}
                        className="text-gray-500 hover:text-gray-700 p-2 hover:bg-gray-100 rounded-lg transition-all"
                        aria-label="Close import preview"
                      >
                        <Icons.X className="w-6 h-6" />
                      </button>
                    </div>

                    <div className="mb-6">
                      <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-3 sm:p-4 mb-4">
                        <p className="text-blue-800 font-semibold text-sm sm:text-base">
                          📦 {importPreviewData.length} challenge
                          {importPreviewData.length !== 1 ? "s" : ""} found
                        </p>
                      </div>

                      <h3 className="font-bold text-base sm:text-lg text-gray-800 mb-3">
                        Challenges to Import:
                      </h3>
                      <div className="space-y-2 max-h-96 overflow-y-auto border border-gray-200 rounded-lg p-2">
                        {importPreviewData.map((challenge, idx) => {
                          const isDuplicate = customChallenges.some(
                            (c) =>
                              c.title.toLowerCase() ===
                              challenge.title.toLowerCase(),
                          );

                          return (
                            <div
                              key={idx}
                              className={`p-3 sm:p-4 rounded-lg border-2 transition-all ${
                                isDuplicate
                                  ? "bg-yellow-50 border-yellow-300"
                                  : "bg-gray-50 border-gray-200 hover:border-gray-300"
                              }`}
                            >
                              <div className="flex flex-wrap items-center gap-2 mb-2">
                                <div className="font-semibold text-gray-800 text-sm sm:text-base">
                                  {challenge.title}
                                </div>
                                <span
                                  className={`px-2 py-1 rounded-full text-xs font-semibold ${getTopicColor(challenge.topic)}`}
                                  role="status"
                                  aria-label={`Topic: ${challenge.topic}`}
                                >
                                  {challenge.topic}
                                </span>
                                {isDuplicate && (
                                  <span
                                    className="px-2 py-1 rounded-full text-xs font-semibold bg-yellow-200 text-yellow-900 border border-yellow-400"
                                    role="status"
                                  >
                                    ⚠️ Duplicate - Will Skip
                                  </span>
                                )}
                              </div>
                              <div className="text-xs sm:text-sm text-gray-600">
                                {challenge.description}
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    </div>

                    <div className="flex flex-col sm:flex-row gap-3 sm:gap-4">
                      <button
                        onClick={() => setShowImportPreview(false)}
                        className="flex-1 bg-gray-300 text-gray-700 px-6 py-3 rounded-lg font-bold hover:bg-gray-400 active:bg-gray-500 transition-all"
                      >
                        Cancel
                      </button>
                      <button
                        onClick={() => {
                          confirmImport();
                          setShowImportPreview(false);
                        }}
                        className="flex-1 bg-purple-500 text-white px-6 py-3 rounded-lg font-bold hover:bg-purple-600 active:bg-purple-700 transition-all"
                      >
                        Import All
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {/* Email Modal */}
              {showEmailModal && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 overflow-y-auto">
                  <div className="bg-white rounded-2xl p-4 sm:p-6 md:p-8 max-w-3xl w-full max-h-[90vh] overflow-y-auto modal-content my-4">
                    <div className="flex justify-between items-center mb-4 sm:mb-6">
                      <h2 className="text-xl sm:text-2xl font-bold text-gray-800">
                        Email Results
                      </h2>
                      <button
                        onClick={() => setShowEmailModal(false)}
                        className="text-gray-500 hover:text-gray-700 p-2 hover:bg-gray-100 rounded-lg transition-all"
                        aria-label="Close email modal"
                      >
                        <Icons.X className="w-6 h-6" />
                      </button>
                    </div>

                    <div className="space-y-4 mb-6">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Recipients{" "}
                          <span className="text-red-500" aria-label="required">
                            *
                          </span>
                        </label>
                        <input
                          type="text"
                          value={emailForm.recipients}
                          onChange={(e) =>
                            setEmailForm({
                              ...emailForm,
                              recipients: e.target.value,
                            })
                          }
                          placeholder="email@example.com, another@example.com"
                          className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none transition-all"
                          aria-required="true"
                        />
                        <p className="text-xs text-gray-500 mt-2 flex items-center gap-1">
                          <span>ℹ️</span>
                          <span>
                            Enter one or more email addresses separated by
                            commas
                          </span>
                        </p>
                      </div>

                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Subject{" "}
                          <span className="text-red-500" aria-label="required">
                            *
                          </span>
                        </label>
                        <input
                          type="text"
                          value={emailForm.subject}
                          onChange={(e) =>
                            setEmailForm({
                              ...emailForm,
                              subject: e.target.value,
                            })
                          }
                          placeholder="Design Sprint Results"
                          className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none transition-all"
                          aria-required="true"
                        />
                      </div>

                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Optional Message
                        </label>
                        <textarea
                          value={emailForm.message}
                          onChange={(e) =>
                            setEmailForm({
                              ...emailForm,
                              message: e.target.value,
                            })
                          }
                          placeholder="Add a personal message (optional)"
                          rows="4"
                          className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none transition-all"
                        />
                      </div>

                      <div className="bg-gray-50 border-2 border-gray-200 rounded-lg p-3 sm:p-4">
                        <h3 className="font-bold text-gray-800 mb-2 text-sm sm:text-base">
                          Email Preview
                        </h3>
                        <div className="text-xs sm:text-sm text-gray-600 whitespace-pre-wrap max-h-48 sm:max-h-64 overflow-y-auto bg-white p-3 rounded border border-gray-200">
                          {emailForm.message && (
                            <>
                              {emailForm.message}
                              {"\n\n"}
                            </>
                          )}
                          {formatEmailBody()}
                        </div>
                      </div>

                      {prototypeImages.length > 0 && (
                        <div className="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-3 sm:p-4">
                          <div className="flex items-start gap-2 sm:gap-3">
                            <Icons.Image className="w-5 h-5 text-yellow-600 flex-shrink-0 mt-0.5" />
                            <div>
                              <p className="text-sm font-semibold text-yellow-800">
                                📎 Note about images
                              </p>
                              <p className="text-xs sm:text-sm text-yellow-700 mt-1">
                                You have {prototypeImages.length} prototype
                                image{prototypeImages.length !== 1 ? "s" : ""}.
                                Please manually attach them to your email after
                                it opens in your email client.
                              </p>
                            </div>
                          </div>
                        </div>
                      )}
                    </div>

                    <div className="flex flex-col sm:flex-row gap-3 sm:gap-4">
                      <button
                        onClick={() => setShowEmailModal(false)}
                        className="flex-1 bg-gray-300 text-gray-700 px-6 py-3 rounded-lg font-bold hover:bg-gray-400 active:bg-gray-500 transition-all"
                      >
                        Cancel
                      </button>
                      <button
                        onClick={openEmailClient}
                        className="flex-1 bg-purple-500 text-white px-6 py-3 rounded-lg font-bold hover:bg-purple-600 active:bg-purple-700 transition-all flex items-center justify-center gap-2"
                      >
                        <Icons.Mail className="w-5 h-5" />
                        Open Email Client
                      </button>
                    </div>
                  </div>
                </div>
              )}
            </div>
          );
        }

        // Complete Screen
        if (gameState === "complete") {
          return (
            <div className="min-h-screen bg-gradient-to-br from-green-50 to-blue-50 p-8">
              <div className="max-w-4xl mx-auto">
                <div className="bg-white rounded-2xl shadow-2xl p-12">
                  <div className="text-center mb-8">
                    <Icons.Trophy className="w-24 h-24 mx-auto mb-6 text-yellow-500" />
                    <h1 className="text-4xl font-bold mb-4 text-gray-800">
                      Design Sprint Complete!
                    </h1>
                    {gameMode === "team" && (
                      <div className="text-2xl font-bold text-purple-600 mb-2">
                        Team: {teamName}
                      </div>
                    )}
                    <div className="text-6xl font-bold text-purple-600 mb-6">
                      {score} points
                    </div>
                  </div>

                  <div className="bg-gray-50 rounded-xl p-6 mb-8 text-left">
                    <h3 className="font-bold text-xl mb-4 text-gray-800">
                      Your Design Journey
                    </h3>
                    <div className="space-y-3">
                      <div className="bg-white p-4 rounded-lg">
                        <p className="text-gray-700">
                          <strong>Challenge:</strong> {challenge.title}
                          <span
                            className={`ml-2 px-2 py-1 rounded-full text-xs font-semibold ${getTopicColor(challenge.topic)}`}
                          >
                            {challenge.topic}
                          </span>
                        </p>
                      </div>
                      {gameMode === "team" && teamMembers.length > 0 && (
                        <div className="bg-white p-4 rounded-lg">
                          <p className="text-gray-700">
                            <strong>Team Members:</strong>{" "}
                            {teamMembers.join(", ")}
                          </p>
                        </div>
                      )}
                      <div className="bg-blue-50 p-4 rounded-lg">
                        <p className="text-gray-700">
                          <strong>How Might We:</strong>
                        </p>
                        <p className="text-gray-800 mt-1">{hmwStatement}</p>
                      </div>
                      <div className="bg-yellow-50 p-4 rounded-lg">
                        <p className="text-gray-700">
                          <strong>Ideas Generated:</strong> {ideas.length}
                        </p>
                        <div className="mt-2 space-y-1">
                          {ideas.slice(0, 5).map((idea, idx) => {
                            const ideaText = typeof idea === 'object' ? idea.text : idea;
                            return (
                              <p key={idx} className="text-sm text-gray-600">
                                • {ideaText}
                              </p>
                            );
                          })}
                          {ideas.length > 5 && (
                            <p className="text-sm text-gray-500 italic">
                              ...and {ideas.length - 5} more
                            </p>
                          )}
                        </div>
                      </div>
                      <div className="bg-green-50 p-4 rounded-lg">
                        <p className="text-gray-700">
                          <strong>Top 3 Concepts:</strong>
                        </p>
                        <div className="mt-2 space-y-1">
                          {selectedIdeas.map((idea, idx) => {
                            const ideaText = typeof idea === 'object' ? idea.text : idea;
                            return (
                              <p key={idx} className="text-sm text-gray-800">
                                🏆 {ideaText}
                              </p>
                            );
                          })}
                        </div>
                      </div>
                      {prototype && (
                        <div className="bg-purple-50 p-4 rounded-lg">
                          <strong className="text-purple-800">
                            Your Prototype:
                          </strong>
                          <p className="text-gray-700 mt-2">{prototype}</p>
                        </div>
                      )}
                      {prototypeImages.length > 0 && (
                        <div className="bg-purple-50 p-4 rounded-lg">
                          <strong className="text-purple-800 flex items-center gap-2">
                            <Icons.Image className="w-5 h-5" />
                            Prototype Images:
                          </strong>
                          <div className="grid grid-cols-2 sm:grid-cols-3 gap-3 mt-3">
                            {prototypeImages.map((img, idx) => (
                              <div key={idx} className="relative">
                                <img
                                  src={img}
                                  alt={`Prototype sketch ${idx + 1}`}
                                  className="w-full aspect-square object-cover rounded-lg border-2 border-purple-200 image-thumbnail cursor-pointer"
                                  onClick={() => window.open(img, "_blank")}
                                  role="button"
                                  tabIndex={0}
                                  onKeyPress={(e) =>
                                    e.key === "Enter" &&
                                    window.open(img, "_blank")
                                  }
                                />
                                <div className="absolute bottom-2 left-2 bg-purple-600 text-white text-xs px-2 py-1 rounded">
                                  {idx + 1}/{prototypeImages.length}
                                </div>
                              </div>
                            ))}
                          </div>
                          <p className="text-xs text-purple-700 mt-2 italic">
                            💡 Click on any image to view full size
                          </p>
                        </div>
                      )}
                      {iterationNotes && (
                        <div className="bg-pink-50 p-4 rounded-lg">
                          <strong className="text-pink-800">
                            Iteration Notes:
                          </strong>
                          <p className="text-gray-700 mt-2">{iterationNotes}</p>
                        </div>
                      )}
                    </div>
                  </div>

                  <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 mb-6">
                    <button
                      onClick={downloadResults}
                      className="bg-blue-500 text-white px-4 sm:px-6 py-3 rounded-xl font-bold hover:bg-blue-600 active:bg-blue-700 transition-all flex items-center justify-center gap-2 shadow-md hover:shadow-lg"
                      aria-label="Download results as text file"
                    >
                      <Icons.Download className="w-5 h-5" />
                      <span className="hidden sm:inline">Download Results</span>
                      <span className="sm:hidden">Download TXT</span>
                    </button>
                    <button
                      onClick={downloadPDF}
                      className="bg-red-500 text-white px-4 sm:px-6 py-3 rounded-xl font-bold hover:bg-red-600 active:bg-red-700 transition-all flex items-center justify-center gap-2 shadow-md hover:shadow-lg"
                      aria-label="Download results as PDF"
                    >
                      <Icons.Download className="w-5 h-5" />
                      <span className="hidden sm:inline">Download PDF</span>
                      <span className="sm:hidden">PDF</span>
                    </button>
                    <button
                      onClick={openEmailModal}
                      className="bg-purple-500 text-white px-4 sm:px-6 py-3 rounded-xl font-bold hover:bg-purple-600 active:bg-purple-700 transition-all flex items-center justify-center gap-2 shadow-md hover:shadow-lg"
                      aria-label="Email results"
                    >
                      <Icons.Mail className="w-5 h-5" />
                      <span className="hidden sm:inline">Email Results</span>
                      <span className="sm:hidden">Email</span>
                    </button>
                    <button
                      onClick={copyToClipboard}
                      className="bg-green-500 text-white px-4 sm:px-6 py-3 rounded-xl font-bold hover:bg-green-600 active:bg-green-700 transition-all flex items-center justify-center gap-2 shadow-md hover:shadow-lg"
                      aria-label="Copy results to clipboard"
                    >
                      <Icons.Copy className="w-5 h-5" />
                      <span className="hidden sm:inline">Copy Summary</span>
                      <span className="sm:hidden">Copy</span>
                    </button>
                  </div>

                  <div className="flex flex-col sm:flex-row gap-3 sm:gap-4 justify-center mt-6">
                    <button
                      onClick={() => startGame(gameMode)}
                      className="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-6 sm:px-8 py-4 rounded-xl text-base sm:text-lg font-bold hover:from-blue-600 hover:to-purple-600 active:from-blue-700 active:to-purple-700 transition-all shadow-lg hover:shadow-xl"
                    >
                      Try New Challenge 🎯
                    </button>
                    <button
                      onClick={() => {
                        setGameState("intro");
                        setGameMode(null);
                      }}
                      className="bg-gray-200 text-gray-700 px-6 sm:px-8 py-4 rounded-xl text-base sm:text-lg font-bold hover:bg-gray-300 active:bg-gray-400 transition-all"
                    >
                      Back to Start
                    </button>
                  </div>
                </div>

                {/* Email Modal */}
                {showEmailModal && (
                  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-2xl p-8 max-w-3xl w-full max-h-[90vh] overflow-y-auto">
                      <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold text-gray-800">
                          Email Results
                        </h2>
                        <button
                          onClick={() => setShowEmailModal(false)}
                          className="text-gray-500 hover:text-gray-700"
                        >
                          <Icons.X className="w-6 h-6" />
                        </button>
                      </div>

                      <div className="space-y-4 mb-6">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">
                            Recipients <span className="text-red-500">*</span>
                          </label>
                          <input
                            type="text"
                            value={emailForm.recipients}
                            onChange={(e) =>
                              setEmailForm({
                                ...emailForm,
                                recipients: e.target.value,
                              })
                            }
                            placeholder="email@example.com, another@example.com"
                            className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none"
                          />
                          <p className="text-xs text-gray-500 mt-1">
                            Enter one or more email addresses separated by
                            commas
                          </p>
                        </div>

                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">
                            Subject <span className="text-red-500">*</span>
                          </label>
                          <input
                            type="text"
                            value={emailForm.subject}
                            onChange={(e) =>
                              setEmailForm({
                                ...emailForm,
                                subject: e.target.value,
                              })
                            }
                            placeholder="Design Sprint Results"
                            className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none"
                          />
                        </div>

                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">
                            Optional Message
                          </label>
                          <textarea
                            value={emailForm.message}
                            onChange={(e) =>
                              setEmailForm({
                                ...emailForm,
                                message: e.target.value,
                              })
                            }
                            placeholder="Add a personal message (optional)"
                            rows="4"
                            className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none"
                          />
                        </div>

                        <div className="bg-gray-50 border-2 border-gray-200 rounded-lg p-4">
                          <h3 className="font-bold text-gray-800 mb-2">
                            Email Preview
                          </h3>
                          <div className="text-sm text-gray-600 whitespace-pre-wrap max-h-64 overflow-y-auto">
                            {emailForm.message && (
                              <>
                                {emailForm.message}
                                {"\n\n"}
                              </>
                            )}
                            {formatEmailBody()}
                          </div>
                        </div>

                        {prototypeImages.length > 0 && (
                          <div className="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4">
                            <div className="flex items-start gap-2">
                              <Icons.Image className="w-5 h-5 text-yellow-600 flex-shrink-0 mt-0.5" />
                              <div>
                                <p className="text-sm font-semibold text-yellow-800">
                                  Note about images
                                </p>
                                <p className="text-xs text-yellow-700 mt-1">
                                  You have {prototypeImages.length} prototype
                                  image(s). Please manually attach them to your
                                  email after it opens in your email client.
                                </p>
                              </div>
                            </div>
                          </div>
                        )}
                      </div>

                      <div className="flex gap-4">
                        <button
                          onClick={() => setShowEmailModal(false)}
                          className="flex-1 bg-gray-300 text-gray-700 px-6 py-3 rounded-lg font-bold hover:bg-gray-400 transition-all"
                        >
                          Cancel
                        </button>
                        <button
                          onClick={openEmailClient}
                          className="flex-1 bg-purple-500 text-white px-6 py-3 rounded-lg font-bold hover:bg-purple-600 transition-all flex items-center justify-center gap-2"
                        >
                          <Icons.Mail className="w-5 h-5" />
                          Open Email Client
                        </button>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            </div>
          );
        }

        // Playing Screen
        const PhaseIcon = phases[currentPhase].icon;

        return (
          <div className="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 p-8">
            <div className="max-w-6xl mx-auto">
              <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
                <div className="flex justify-between items-center">
                  <div>
                    <div className="flex items-center gap-3 mb-2">
                      <h2 className="text-2xl font-bold text-gray-800">
                        {challenge.title}
                      </h2>
                      <span
                        className={`px-3 py-1 rounded-full text-sm font-semibold ${getTopicColor(challenge.topic)}`}
                      >
                        {challenge.topic}
                      </span>
                      {gameMode === "team" && (
                        <span className="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm font-semibold">
                          Team: {teamName}
                        </span>
                      )}
                    </div>
                    <p className="text-gray-600">{challenge.description}</p>
                  </div>
                  <div className="text-right">
                    <div className="text-3xl font-bold text-purple-600">
                      {score}
                    </div>
                    <div className="text-sm text-gray-500">points</div>
                  </div>
                </div>
                {gameMode === "team" && teamMembers.length > 0 && (
                  <div className="mt-4 pt-4 border-t border-gray-200">
                    <div className="flex flex-wrap gap-2">
                      {teamMembers.map((member, idx) => (
                        <span
                          key={idx}
                          className="bg-blue-50 text-blue-700 px-3 py-1 rounded-full text-sm"
                        >
                          {member}
                        </span>
                      ))}
                    </div>
                  </div>
                )}
              </div>

              <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
                <div className="flex justify-between mb-4">
                  {phases.map((phase, idx) => (
                    <div
                      key={idx}
                      className="flex flex-col items-center flex-1"
                    >
                      <div
                        className={`w-12 h-12 rounded-full flex items-center justify-center ${
                          idx === currentPhase
                            ? phase.color
                            : idx < currentPhase
                              ? "bg-green-500"
                              : "bg-gray-200"
                        } text-white mb-2 transition-all`}
                      >
                        <phase.icon className="w-6 h-6" />
                      </div>
                      <div
                        className={`text-xs font-medium ${idx === currentPhase ? "text-gray-800" : "text-gray-400"}`}
                      >
                        {phase.name}
                      </div>
                    </div>
                  ))}
                </div>
                <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
                  <div
                    className="h-full bg-gradient-to-r from-blue-500 to-purple-500 transition-all duration-500"
                    style={{
                      width: `${(currentPhase / (phases.length - 1)) * 100}%`,
                    }}
                  />
                </div>
              </div>

              <div className="grid md:grid-cols-3 gap-6">
                <div className="bg-white rounded-xl shadow-lg p-6">
                  <h3 className="font-bold text-lg mb-4 text-gray-800">
                    Design Brief
                  </h3>
                  <div className="space-y-4">
                    <div className="bg-blue-50 p-4 rounded-lg">
                      <div className="font-semibold text-blue-800 mb-1">
                        User Persona
                      </div>
                      <p className="text-sm text-gray-700">
                        {challenge.persona}
                      </p>
                    </div>
                    <div className="bg-red-50 p-4 rounded-lg">
                      <div className="font-semibold text-red-800 mb-1">
                        Pain Point
                      </div>
                      <p className="text-sm text-gray-700">
                        {challenge.painPoint}
                      </p>
                    </div>
                    <div className="bg-yellow-50 p-4 rounded-lg">
                      <div className="font-semibold text-yellow-800 mb-1">
                        💡 Tip
                      </div>
                      <p className="text-sm text-gray-700">
                        {phases[currentPhase].tip}
                      </p>
                    </div>
                    {gameMode === "team" && currentPhase === 1 && (
                      <div className="bg-purple-50 p-4 rounded-lg">
                        <div className="font-semibold text-purple-800 mb-2">
                          Team Contribution
                        </div>
                        <select
                          value={playerName}
                          onChange={(e) => setPlayerName(e.target.value)}
                          className="w-full p-2 border-2 border-purple-300 rounded-lg focus:border-purple-500 focus:outline-none text-sm"
                        >
                          <option value="">Who's contributing?</option>
                          {teamMembers.map((member, idx) => (
                            <option key={idx} value={member}>
                              {member}
                            </option>
                          ))}
                        </select>
                        <p className="text-xs text-gray-600 mt-2">
                          Select your name before adding ideas
                        </p>
                      </div>
                    )}
                  </div>
                </div>

                <div className="md:col-span-2 bg-white rounded-xl shadow-lg p-6">
                  <div className="flex items-center gap-3 mb-6">
                    <div
                      className={`p-3 rounded-lg ${phases[currentPhase].color}`}
                    >
                      <PhaseIcon className="w-8 h-8 text-white" />
                    </div>
                    <div>
                      <h3 className="font-bold text-2xl text-gray-800">
                        {phases[currentPhase].name}
                      </h3>
                      <p className="text-gray-600">
                        {phases[currentPhase].instruction}
                      </p>
                    </div>
                  </div>

                  {currentPhase === 0 && (
                    <div>
                      <input
                        type="text"
                        value={userInput}
                        onChange={(e) => setUserInput(e.target.value)}
                        onKeyPress={(e) => e.key === "Enter" && handleSubmit()}
                        placeholder={phases[currentPhase].placeholder}
                        className="w-full p-4 border-2 border-gray-300 rounded-lg mb-4 focus:border-blue-500 focus:outline-none"
                      />
                      <button
                        onClick={handleSubmit}
                        className="w-full bg-blue-500 text-white py-3 rounded-lg font-bold hover:bg-blue-600 transition-all"
                      >
                        Submit HMW Statement
                      </button>
                    </div>
                  )}

                  {currentPhase === 1 && (
                    <div>
                      {!timerActive && ideas.length === 0 && (
                        <button
                          onClick={startTimer}
                          className="w-full bg-yellow-500 text-white py-4 rounded-lg font-bold mb-4 hover:bg-yellow-600 transition-all"
                        >
                          Start Idea Generation! 🚀
                        </button>
                      )}

                      {timerActive && (
                        <div className="bg-red-50 border-2 border-red-300 rounded-lg p-4 mb-4 text-center">
                          <div className="text-4xl font-bold text-red-600">
                            {Math.floor(timer / 60)}:
                            {(timer % 60).toString().padStart(2, "0")}
                          </div>
                          <div className="text-sm text-gray-600">
                            Ideas: {ideas.length} | Target: 10+
                          </div>
                        </div>
                      )}

                      <input
                        type="text"
                        value={userInput}
                        onChange={(e) => setUserInput(e.target.value)}
                        onKeyPress={(e) => e.key === "Enter" && handleSubmit()}
                        placeholder={phases[currentPhase].placeholder}
                        className="w-full p-4 border-2 border-gray-300 rounded-lg mb-4 focus:border-yellow-500 focus:outline-none"
                        disabled={!timerActive && ideas.length === 0}
                      />

                      <div className="space-y-2 mb-4 max-h-60 overflow-y-auto">
                        {ideas.map((idea, idx) => (
                          <div
                            key={idx}
                            className="bg-yellow-50 p-3 rounded-lg flex items-center gap-2"
                          >
                            <div className="bg-yellow-500 text-white w-6 h-6 rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0">
                              {idx + 1}
                            </div>
                            <div className="text-gray-700 flex-1">
                              {isCollaborative && typeof idea === "object" ? (
                                <div>
                                  <div>{idea.text}</div>
                                  <div className="text-xs text-gray-500 mt-1">
                                    by {idea.author}
                                  </div>
                                </div>
                              ) : (
                                idea
                              )}
                            </div>
                          </div>
                        ))}
                      </div>

                      {ideas.length >= 5 && (
                        <button
                          onClick={nextPhase}
                          disabled={isCollaborative && !isHost}
                          className="w-full bg-green-500 text-white py-3 rounded-lg font-bold hover:bg-green-600 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                          {isCollaborative && !isHost
                            ? `Waiting for host... (${ideas.length} ideas)`
                            : `Continue to Selection (${ideas.length} ideas) →`
                          }
                        </button>
                      )}
                    </div>
                  )}

                  {currentPhase === 2 && (
                    <div>
                      <p className="text-gray-600 mb-4">
                        Click on 3 ideas to select them:
                      </p>
                      <div className="space-y-2 mb-4 max-h-96 overflow-y-auto">
                        {ideas.map((idea, idx) => {
                          const ideaId = typeof idea === 'object' ? idea.id : idea;
                          const ideaText = typeof idea === 'object' ? idea.text : idea;
                          const ideaAuthor = typeof idea === 'object' ? idea.author : null;
                          const isSelected = selectedIdeas.some(selected => 
                            typeof selected === 'object' ? selected.id === ideaId : selected === ideaId
                          );
                          
                          return (
                            <div
                              key={idx}
                              onClick={() => toggleIdeaSelection(idea)}
                              className={`p-4 rounded-lg cursor-pointer transition-all ${
                                isSelected
                                  ? "bg-green-500 text-white border-2 border-green-600"
                                  : "bg-gray-50 hover:bg-gray-100 border-2 border-gray-200"
                              }`}
                            >
                              <div className="flex items-center gap-3">
                                <div
                                  className={`w-8 h-8 rounded-full flex items-center justify-center font-bold ${
                                    isSelected
                                      ? "bg-white text-green-500"
                                      : "bg-gray-300 text-gray-600"
                                  }`}
                                >
                                  {isSelected ? "✓" : idx + 1}
                                </div>
                                <div className="flex-1">
                                  {ideaText}
                                  {ideaAuthor && (
                                    <div className="text-xs mt-1 opacity-75">by {ideaAuthor}</div>
                                  )}
                                </div>
                              </div>
                            </div>
                          );
                        })}
                      </div>

                      {selectedIdeas.length === 3 && (
                        <button
                          onClick={nextPhase}
                          className="w-full bg-green-500 text-white py-3 rounded-lg font-bold hover:bg-green-600 transition-all"
                        >
                          Prototype Top Idea →
                        </button>
                      )}
                    </div>
                  )}

                  {currentPhase === 3 && (
                    <div>
                      <div className="bg-purple-50 p-4 rounded-lg mb-4">
                        <div className="font-bold text-purple-800 mb-2">
                          Your Top Idea:
                        </div>
                        <p className="text-gray-700">
                          {typeof selectedIdeas[0] === 'object' ? selectedIdeas[0].text : selectedIdeas[0]}
                        </p>
                      </div>
                      <textarea
                        value={userInput}
                        onChange={(e) => setUserInput(e.target.value)}
                        placeholder={phases[currentPhase].placeholder}
                        rows="6"
                        className="w-full p-4 border-2 border-gray-300 rounded-lg mb-4 focus:border-purple-500 focus:outline-none"
                      />

                      <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Add Images or Sketches (Optional)
                        </label>
                        <input
                          type="file"
                          accept="image/*"
                          onChange={handleImageUpload}
                          className="hidden"
                          id="image-upload"
                          aria-label="Upload prototype image"
                        />
                        <label
                          htmlFor="image-upload"
                          className="inline-flex items-center gap-2 bg-purple-100 text-purple-700 px-4 py-3 rounded-lg font-semibold hover:bg-purple-200 active:bg-purple-300 transition-all cursor-pointer border-2 border-purple-200 hover:border-purple-300"
                          role="button"
                          tabIndex={0}
                          onKeyPress={(e) =>
                            e.key === "Enter" &&
                            document.getElementById("image-upload").click()
                          }
                        >
                          <Icons.Upload className="w-5 h-5" />
                          <span>Upload Image</span>
                        </label>
                        <div className="bg-purple-50 border border-purple-200 rounded-lg p-2 mt-2">
                          <p className="text-xs text-purple-800 flex items-center gap-1">
                            <span>ℹ️</span>
                            <span>
                              PNG, JPG, GIF, or SVG • Max 5MB • Up to 3 images
                            </span>
                          </p>
                        </div>
                      </div>

                      {prototypeImages.length > 0 && (
                        <div className="mb-4">
                          <div className="font-medium text-gray-700 mb-3 text-sm sm:text-base">
                            📷 Uploaded Images ({prototypeImages.length}/3)
                          </div>
                          <div className="grid grid-cols-2 sm:grid-cols-3 gap-3">
                            {prototypeImages.map((img, idx) => (
                              <div key={idx} className="relative group">
                                <img
                                  src={img}
                                  alt={`Prototype sketch ${idx + 1}`}
                                  className="w-full aspect-square object-cover rounded-lg border-2 border-gray-300 image-thumbnail"
                                />
                                <button
                                  onClick={() => removeImage(idx)}
                                  className="absolute top-2 right-2 bg-red-500 text-white p-2 rounded-full hover:bg-red-600 active:bg-red-700 transition-all opacity-0 group-hover:opacity-100 shadow-lg"
                                  aria-label={`Remove image ${idx + 1}`}
                                >
                                  <Icons.X className="w-4 h-4" />
                                </button>
                                <div className="absolute bottom-2 left-2 bg-black bg-opacity-60 text-white text-xs px-2 py-1 rounded">
                                  {idx + 1}/3
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}

                      <button
                        onClick={handleSubmit}
                        className="w-full bg-purple-500 text-white py-3 rounded-lg font-bold hover:bg-purple-600 transition-all"
                      >
                        Submit Prototype
                      </button>
                    </div>
                  )}

                  {currentPhase === 4 && (
                    <div>
                      <div className="bg-purple-50 p-4 rounded-lg mb-4">
                        <div className="font-bold text-purple-800 mb-2">
                          Your Prototype:
                        </div>
                        <p className="text-gray-700">{prototype}</p>
                      </div>
                      <textarea
                        value={userInput}
                        onChange={(e) => setUserInput(e.target.value)}
                        placeholder={phases[currentPhase].placeholder}
                        rows="4"
                        className="w-full p-4 border-2 border-gray-300 rounded-lg mb-4 focus:border-pink-500 focus:outline-none"
                      />
                      <button
                        onClick={handleSubmit}
                        disabled={isCollaborative && !isHost}
                        className="w-full bg-pink-500 text-white py-3 rounded-lg font-bold hover:bg-pink-600 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                      >
                        {isCollaborative && !isHost 
                          ? "Waiting for host to complete..." 
                          : "Complete Design Sprint! 🎉"
                        }
                      </button>
                    </div>
                  )}
                </div>
              </div>
            </div>
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<IDEOGame />);
    </script>
  </body>
</html>
